#!/usr/bin/env python3
"""
AI Website Reader - Reads and summarizes content from website links
Uses BeautifulSoup for web scraping, Selenium for JavaScript rendering, 
and OpenAI API for intelligent analysis and text-to-speech
"""

import os
import sys
import requests
from bs4 import BeautifulSoup
from urllib.parse import urljoin, urlparse
import json
from datetime import datetime
import time

try:
    from openai import OpenAI
except ImportError:
    print("Error: OpenAI package not installed. Install with: pip install openai requests beautifulsoup4 selenium")
    sys.exit(1)

try:
    from selenium import webdriver
    from selenium.webdriver.common.by import By
    from selenium.webdriver.support.ui import WebDriverWait
    from selenium.webdriver.support import expected_conditions as EC
    from selenium.webdriver.chrome.service import Service
    from selenium.webdriver.chrome.options import Options
    SELENIUM_AVAILABLE = True
except ImportError:
    SELENIUM_AVAILABLE = False


class AIWebsiteReader:
    def __init__(self, api_key=None):
        """Initialize the AI reader with OpenAI API key"""
        self.api_key = api_key or os.getenv('OPENAI_API_KEY')
        if not self.api_key:
            raise ValueError("OpenAI API key not provided. Set OPENAI_API_KEY environment variable or pass api_key parameter.")
        
        self.client = OpenAI(api_key=self.api_key)
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
        self.driver = None

    def init_selenium(self):
        """Initialize Selenium WebDriver for JavaScript rendering"""
        if not SELENIUM_AVAILABLE:
            print("Warning: Selenium not available. Install with: pip install selenium webdriver-manager")
            return False
        
        try:
            from webdriver_manager.chrome import ChromeDriverManager
            
            chrome_options = Options()
            chrome_options.add_argument("--headless")
            chrome_options.add_argument("--no-sandbox")
            chrome_options.add_argument("--disable-dev-shm-usage")
            chrome_options.add_argument("--disable-blink-features=AutomationControlled")
            chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
            chrome_options.add_experimental_option('useAutomationExtension', False)
            
            service = Service(ChromeDriverManager().install())
            self.driver = webdriver.Chrome(service=service, options=chrome_options)
            return True
        except Exception as e:
            print(f"Warning: Could not initialize Selenium: {e}")
            return False

    def fetch_website(self, url, use_javascript=True):
        """Fetch website content from URL, with JavaScript rendering support"""
        try:
            # Try JavaScript rendering first if requested
            if use_javascript and SELENIUM_AVAILABLE:
                if not self.driver:
                    if not self.init_selenium():
                        return self._fetch_website_simple(url)
                
                try:
                    print("Rendering with JavaScript support...")
                    self.driver.get(url)
                    # Wait for content to load
                    WebDriverWait(self.driver, 10).until(
                        EC.presence_of_all_elements_located((By.TAG_NAME, "body"))
                    )
                    time.sleep(2)  # Extra time for dynamic content
                    return self.driver.page_source
                except Exception as e:
                    print(f"JavaScript rendering failed: {e}")
                    return self._fetch_website_simple(url)
            else:
                return self._fetch_website_simple(url)
        except Exception as e:
            raise Exception(f"Failed to fetch website: {e}")

    def _fetch_website_simple(self, url):
        """Simple HTTP fetch without JavaScript rendering"""
        try:
            response = requests.get(url, headers=self.headers, timeout=10)
            response.raise_for_status()
            return response.text
        except requests.exceptions.RequestException as e:
            raise Exception(f"Failed to fetch website: {e}")

    def extract_text(self, html_content):
        """Extract clean text from HTML content"""
        soup = BeautifulSoup(html_content, 'html.parser')
        
        # Remove script and style elements
        for script in soup(["script", "style"]):
            script.decompose()
        
        # Get text
        text = soup.get_text()
        
        # Clean up whitespace
        lines = (line.strip() for line in text.splitlines())
        chunks = (phrase.strip() for line in lines for phrase in line.split("  "))
        text = '\n'.join(chunk for chunk in chunks if chunk)
        
        return text

    def get_website_title(self, html_content):
        """Extract website title"""
        soup = BeautifulSoup(html_content, 'html.parser')
        title = soup.find('title')
        return title.string if title else "Unknown"

    def summarize(self, content, max_length=500):
        """Summarize website content using AI"""
        # Limit content length to avoid token limits
        content = content[:4000]
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {
                        "role": "system",
                        "content": "You are a helpful assistant that summarizes website content concisely and accurately."
                    },
                    {
                        "role": "user",
                        "content": f"Please summarize the following website content in {max_length} characters or less:\n\n{content}"
                    }
                ],
                temperature=0.7,
                max_tokens=200
            )
            return response.choices[0].message.content
        except Exception as e:
            raise Exception(f"AI summarization failed: {e}")

    def analyze(self, content, query):
        """Analyze website content based on a specific query"""
        content = content[:4000]
        
        try:
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[
                    {
                        "role": "system",
                        "content": "You are a helpful assistant that answers questions about website content."
                    },
                    {
                        "role": "user",
                        "content": f"Based on the following website content, answer this question: {query}\n\nContent:\n{content}"
                    }
                ],
                temperature=0.7,
                max_tokens=300
            )
            return response.choices[0].message.content
        except Exception as e:
            raise Exception(f"AI analysis failed: {e}")

    def read_site(self, url, action="summarize", query=None, use_tts=False, use_javascript=True):
        """Main method to read and process a website"""
        print(f"\n{'='*60}")
        print(f"Reading: {url}")
        print(f"{'='*60}\n")
        
        # Fetch the website
        print("Fetching website...")
        if use_javascript:
            print("(with JavaScript support)")
        html = self.fetch_website(url, use_javascript=use_javascript)
        
        # Extract information
        title = self.get_website_title(html)
        text = self.extract_text(html)
        
        print(f"Title: {title}")
        print(f"Content length: {len(text)} characters\n")
        
        # Process based on action
        result = None
        if action == "summarize":
            print("AI is analyzing and summarizing the content...\n")
            result = self.summarize(text)
            print("SUMMARY:")
            print("-" * 60)
            print(result)
        elif action == "analyze" and query:
            print(f"AI is analyzing: {query}\n")
            result = self.analyze(text, query)
            print("ANALYSIS RESULT:")
            print("-" * 60)
            print(result)
        elif action == "extract":
            print("EXTRACTED TEXT (first 1000 chars):")
            print("-" * 60)
            result = text
            print(result[:1000] + ("..." if len(result) > 1000 else ""))
        
        # Text-to-speech
        if use_tts and result:
            print("\nGenerating audio...")
            self.text_to_speech(result, title)
        
        print(f"\n{'='*60}\n")
        
        return {
            "url": url,
            "title": title,
            "text_length": len(text),
            "timestamp": datetime.now().isoformat(),
            "result": result if action in ["summarize", "analyze"] else text[:1000]
        }

    def text_to_speech(self, text, filename_prefix="output"):
        """Convert text to speech using OpenAI's TTS API and play it"""
        try:
            # Limit text length for TTS
            tts_text = text[:3000]
            
            print("Converting text to speech...")
            # Use OpenAI's text-to-speech API
            response = self.client.audio.speech.create(
                model="tts-1",
                voice="alloy",  # Options: alloy, echo, fishi, onyx, nova, shimmer
                input=tts_text
            )
            
            # Save audio file
            audio_filename = f"{filename_prefix.replace(' ', '_')}_audio.mp3"
            audio_path = os.path.join(os.getcwd(), audio_filename)
            response.stream_to_file(audio_path)
            print(f"Audio saved to: {audio_path}")
            
            # Try to play the audio
            try:
                import platform
                if platform.system() == 'Windows':
                    os.startfile(audio_path)
                elif platform.system() == 'Darwin':  # macOS
                    os.system(f'open "{audio_path}"')
                else:  # Linux
                    os.system(f'xdg-open "{audio_path}"')
                print("Playing audio...")
            except Exception as e:
                print(f"Could not auto-play audio, but saved to {audio_path}")
                
        except Exception as e:
            print(f"Error in text-to-speech: {e}")


def main():
    """Main function with CLI interface"""
    print("\n" + "="*60)
    print("        AI WEBSITE READER (with TTS & JavaScript Support)")
    print("="*60)
    
    # Get API key
    api_key = os.getenv('OPENAI_API_KEY')
    if not api_key:
        print("\nNo API key found. Please set OPENAI_API_KEY environment variable.")
        api_key = input("Enter your OpenAI API key: ")
    
    try:
        reader = AIWebsiteReader(api_key)
    except ValueError as e:
        print(f"Error: {e}")
        return
    
    # Interactive loop
    while True:
        print("\nOptions:")
        print("1. Summarize a website")
        print("2. Ask a question about a website")
        print("3. Extract text from website")
        print("4. Summarize with audio (text-to-speech)")
        print("5. Analyze with audio")
        print("6. Settings")
        print("7. Exit")
        
        choice = input("\nChoose an option (1-7): ").strip()
        
        if choice == "1":
            url = input("Enter website URL: ").strip()
            try:
                reader.read_site(url, action="summarize", use_javascript=True)
            except Exception as e:
                print(f"Error: {e}")
        
        elif choice == "2":
            url = input("Enter website URL: ").strip()
            query = input("What would you like to know about the website? ").strip()
            try:
                reader.read_site(url, action="analyze", query=query, use_javascript=True)
            except Exception as e:
                print(f"Error: {e}")
        
        elif choice == "3":
            url = input("Enter website URL: ").strip()
            try:
                reader.read_site(url, action="extract", use_javascript=True)
            except Exception as e:
                print(f"Error: {e}")
        
        elif choice == "4":
            url = input("Enter website URL: ").strip()
            try:
                reader.read_site(url, action="summarize", use_tts=True, use_javascript=True)
            except Exception as e:
                print(f"Error: {e}")
        
        elif choice == "5":
            url = input("Enter website URL: ").strip()
            query = input("What would you like to know about the website? ").strip()
            try:
                reader.read_site(url, action="analyze", query=query, use_tts=True, use_javascript=True)
            except Exception as e:
                print(f"Error: {e}")
        
        elif choice == "6":
            print("\nSettings:")
            print("Selenium (JavaScript support):", "Available" if SELENIUM_AVAILABLE else "Not installed")
            if SELENIUM_AVAILABLE:
                print("  Install: pip install selenium webdriver-manager")
            print("\nOpenAI API configured:", "Yes" if api_key else "No")
            print("TTS Voice: alloy (changeable in code)")
        
        elif choice == "7":
            print("\nGoodbye!")
            if reader.driver:
                reader.driver.quit()
            break
        
        else:
            print("Invalid option. Please try again.")


if __name__ == "__main__":
    if len(sys.argv) > 1:
        # Command line usage
        url = sys.argv[1]
        action = sys.argv[2] if len(sys.argv) > 2 else "summarize"
        query = sys.argv[3] if len(sys.argv) > 3 else None
        use_tts = "--tts" in sys.argv
        use_js = "--no-js" not in sys.argv
        
        api_key = os.getenv('OPENAI_API_KEY')
        if not api_key:
            print("Error: OPENAI_API_KEY environment variable not set")
            sys.exit(1)
        
        try:
            reader = AIWebsiteReader(api_key)
            reader.read_site(url, action=action, query=query, use_tts=use_tts, use_javascript=use_js)
        except Exception as e:
            print(f"Error: {e}")
            sys.exit(1)
    else:
        # Interactive mode
        main()
